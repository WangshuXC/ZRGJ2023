{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代码编写</title>
    <script src="{% static 'js/jquery-3.7.0.js' %}"></script>
    <script src="{% static 'plugins/ace-builds-1.5.0/src/ace.js' %}"></script>
    <script src="{% static 'plugins/ace-builds-1.5.0/src/ext-language_tools.js' %}"></script>
    <link href="{% static 'css/bootstrap.css' %}" rel="stylesheet">
    <style>
        body {
            height: 100vh;
            background: linear-gradient(#141e30,#243b55);
            display: flex;
            flex-direction: column;
        
        }
        #editor {
            min-width: 90vw;
            min-height:500px;
            margin-top: 30px;
            margin-bottom: 30px;
            
        }
        .logo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1); /* 半透明黑色遮罩 */
            pointer-events: none; /* 使遮罩不响应任何事件 */
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
        }

    </style>
</head>
<body>
    <!-- <div class="logo">
        <img src="{% static 'img/2.png' %}" width="600px" alt="">
    </div> -->
    <nav class="navbar navbar-expand-sm navbar-light bg-dark" style="z-index: 11;">
        <a class="navbar-brand" href="#">
            <img src="{% static 'img/2.png' %}" width="40" height="40" alt="">
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav" >
            <ul class="nav nav-pills nav-fill">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/codes/">代码编写</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/query/">API查询</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="container-fluid d-flex flex-column" style="flex:1;">
        <div id="editor" style="flex: 1;"></div>
        <script>
            var editor = ace.edit("editor");
            var langTools = ace.require("ace/ext/language_tools");
            var session = editor.getSession();
            editor.$blockScrolling = Infinity;
            editor.setReadOnly(false);
            editor.setFontSize(20);
            editor.session.setMode("ace/mode/python");
            editor.setTheme("ace/theme/twilight"); 
            //editor.execCommand('find');
            editor.setShowPrintMargin(false);
            editor.setOptions({
                wrap: true,
                autoScrollEditorIntoView: true, 
                enableBasicAutocompletion: true,
                enableSnippets: true,
                enableLiveAutocompletion: true
            });
            //自定义代码提示
            let myHint = [{
                name: "forEach", //显示的名称，‘奖金’
                value: "forEach((v,k)=>{})", //插入的值，‘100’
                //caption: "fe",//这才是关键字
                score: 100, //分数，越大的排在越上面
                meta: "遍历" //描述，‘我的常量
            }]
            //setCompleters(myHint);
            function setCompleters(comp) {
                let tipsCompleter = {
                    getCompletions: (editor, session, pos, prefix, callback) => {
                        callback(null, comp)
                    }
                }
                langTools.setCompleters([tipsCompleter])
            }
            function resetCompleter() {
                var completersDefault = [langTools.snippetCompleter, langTools.textCompleter, langTools.keyWordCompleter];
                langTools.setCompleters(completersDefault);
            }
            importModule = {};//导入的包
            localVariable = {};//工作区的变量
            localClass = {};//工作区的类
            localFunction = {};//工作区的函数返回值类型
            editor.on('change',function(event){
                console.log(event);
                if(event.action == 'insert') {
                    if(event.lines.length == 1) {
                        if (event.lines[0] == '.') {
                            var cursorPosition = editor.selection.getCursor();
                            //console.log(cursorPosition);
                            //var token = session.getTokenAt(cursorPosition.row, cursorPosition.column);
                            //console.log(token);
                            var currentLine = session.getLine(cursorPosition.row);
                            if (testVariable(currentLine)) {
                                var match = currentLine.match(/\s*=\s*/);
                                var localVar = currentLine.slice(0, match.index);
                                var varValue = currentLine.slice(match.index + match[0].length);
                                varValue = varValue.replace(/\(.+?\)/g, "()");
                                currentLine = varValue;
                            }
                            var firstVar = varValue.split('.', 1)[0];
                            firstVar = firstVar.replace(/\(.*\)/,'');
                            console.log('firstVar: ', firstVar);
                            var firstVarType;
                            //对第一个变量进行处理，如果是本地定义的变量或函数，修改其类型
                            if (localVariable[firstVar] != null) {
                                firstVarType = localVariable[firstVar] + '.';
                            }
                            else if (localFunction[firstVar] != null) {
                                var functionDetail = localFunction[firstVar]
                                firstVarType = functionDetail['ret'];
                                if (firstVarType == 'unknown') {
                                    guessFuncRetType(firstVar, varValue.replace(/.+?\./, ''));
                                    return;
                                }
                                else if (firstVarType == 'none') {
                                    return;
                                }
                                else {
                                    firstVarType = firstVarType + '.';
                                }
                            }
                            else {
                                firstVarType = firstVar + '.';
                            }
                            varValue = varValue.replace(/.+?\./, firstVarType);
                            console.log("varValue: ", varValue);
                            $.ajax({
                                url: '/type/',
                                type: 'get',
                                data: { 'line': currentLine.slice(0, -1) },
                                success: function (res) {
                                    var res_str = JSON.parse(res);
                                    console.log(res_str)
                                    console.log(res_str['type']);
                                    setCompleters(myHint);
                                }
                            })
                        }
                        else if (event.lines[0] == ' ' || event.lines[0] == ',') {
                            resetCompleter();
                        }
                    }
                    else if(event.lines.length == 2 && event.lines[0] == '') {
                        console.log('换行');
                        var cursorPosition = editor.selection.getCursor();
                        //console.log(cursorPosition);
                        //var token = session.getTokenAt(cursorPosition.row, cursorPosition.column);
                        //console.log(token);
                        var currentLine = session.getLine(cursorPosition.row).trim();
                        matchCategory(currentLine);
                    }
                    else {
                        for (i = 0; i < event.lines.length; i++) {
                            matchCategory(event.lines[i].trim());
                        }
                    }
                function matchCategory(str) {
                    if (testVariable(str)) {
                        console.log('匹配为赋值');
                        var match = str.match(/\s*=\s*/);
                        var localVar = str.slice(0, match.index);
                        var varValue = str.slice(match.index + match[0].length);
                        if (/^\[.*\]$/.test(varValue)) {
                            localVariable[localVar] = 'List';
                        }
                        else if (/^\{.*\}$/.test(varValue)) {
                            localVariable[localVar] = 'Dict';
                        }
                        else if (/^\(.*\)$/.test(varValue)) {
                            localVariable[localVar] = 'Set';
                        }
                        else if (/^".*"$/.test(varValue) || /^'.*'$/.test(varValue)) {
                            localVariable[localVar] = 'Str';
                        }
                        else {
                            var varValue = varValue.replace(/\(.+?\)/g, "()");
                            var firstVar = varValue.split('.',1)[0];
                            console.log('firstVar: ',firstVar);
                            var firstVarType;
                            //对第一个变量进行处理，如果是本地定义的变量或函数，修改其类型
                            if(localVariable[firstVar] != null) {
                                firstVarType = localVariable[firstVar] + '.';
                            }
                            else if (localFunction[firstVar] != null) {
                                var functionDetail = localFunction[firstVar]
                                firstVarType = functionDetail['ret'];
                                if(firstVarType == 'unknown') {
                                    guessFuncRetType(firstVar,varValue.replace(/.+?\./, ''));
                                    return;
                                }
                                else if(firstVarType == 'none') {
                                    return;
                                }
                                else {
                                    firstVarType = firstVarType + '.';
                                }
                            }
                            else {
                                firstVarType = firstVar + '.';
                            }
                            varValue = varValue.replace(/.+?\./,firstVarType);
                            console.log("varValue: ",varValue);
                            $.ajax({
                                url: '/type/',
                                type: 'get',
                                data: { 'line': varValue },
                                success: function (res) {
                                    var res_str = JSON.parse(res);
                                    localVariable[localVar] = res_str['type'];
                                    console.log(localVariable);
                                }
                            })
                        }
                    }
                    else if (testImport(str)) {
                        console.log('匹配为导入');
                        splitStr = str.split(/\s+/);
                        if (splitStr[0] == 'import' && splitStr.length == 2) {
                            importModule[splitStr[1]] = splitStr[1];
                        }
                        else if (splitStr[0] == 'import' && splitStr.length == 4) {
                            importModule[splitStr[3]] = splitStr[1];
                        }
                        else {
                            importModule[splitStr[3]] = splitStr[1] + '.' + splitStr[3];
                        }
                    }
                    else if(testDef(str)) {
                        console.log('匹配为函数');
                        splitStr = str.split(/\s+/);
                        funcName = splitStr[1].replace(/\(.*\):/,'');
                        temp = {
                            'ret': 'unknown',
                            'method': [],
                        }
                        localFunction[funcName] = temp;
                        console.log(localFunction);
                    }
                    else if(testClass(str)) {
                        console.log('匹配为类');
                        splitStr = str.split(/\s+/);
                        if(splitStr[1].match(/\(/)) {
                            className = splitStr[1].replace(/\(.*\):/, '');
                            localClass[className] = 'none';
                        }
                        else {
                            className = splitStr[1].replace(':', '');
                            localClass[className] = 'none';
                        }
                        console.log(localClass);
                    }
                }
                }
                //匹配赋值语句
                function testVariable(str) {
                    var match = str.match(/\s*=\s*/);
                    if(match != null && /^\w+$/.test(str.slice(0, match.index))) {
                        return true;
                    }
                    else {
                        return false;
                    }
                }
                //匹配导入包的语句
                function testImport(str) {
                    if(/^import\s.+$/.test(str) || /^from\s.+\simport\s.+$/.test(str) || /^import\s.+\sas\s.+$/.test(str)) {
                        return true;
                    }
                    else {
                        return false;
                    }
                }
                //匹配定义函数的语句
                function testDef(str) {
                    if(/^def\s\w+\(.*\):$/.test(str)) { 
                        return true;
                    }
                    else {
                        return false;
                    }
                }
                //匹配定义类的语句
                function testClass(str) {
                    if (/^class\s\w+\({0,1}.*\){0,1}:$/.test(str)) {
                        return true;
                    }
                    else {
                        return false;
                    }
                }
                //猜测函数返回类型
                function guessFuncRetType(func,method) {
                    console.log('进入猜测返回类型',func,method);
                    if(method == '') return;
                    else if(method[method.length - 1] == '.') method = method.slice(0,method.length - 1);
                    localFunction[func]['method'].push(method);
                    $.ajax({
                        url: '/type/',
                        type: 'get',
                        data: { 'line': method },
                        success: function (res) {
                            var res_str = JSON.parse(res);
                            localFunction[func]['ret'] = res_str['type'];
                            console.log(localFunction);
                        }
                    })
                } 
            })
            //langTools.addCompleter(tipsCompleter)
            /*addCompleterToEditor(_comp_cfg)
            function addCompleterToEditor(comp_cfg) {
                ace.config.loadModule("ace/ext/language_tools", function (module) {
                    module.addCompleter({
                        getCompletions: function (editor, session, pos, prefix, callback) {
                            if (prefix.length === 0) { callback(null, []); return }
                            callback(null, comp_cfg);
                        }
                    });
                });
            }*/
            
            //function
            // var v = editor.getValue();// 获取编辑内容
            //editor.setValue("string "); // 设置编辑内容
            //require("lib/ace"); ##引入
            //editor.setTheme("ace/theme/solarized_dark");##设置模板；引入theme-solarized_dark.js模板文件
            //editor.getSession().setMode("ace/mode/javascript"); ##设置程序语言模式
            //editor.setValue("the new text here");##设置内容
            //editor.getValue(); ##取值
            //editor.session.getTextRange(editor.getSelectionRange()); ##获取选择内容
            //editor.insert("Something cool"); ##在光标处插入
            //editor.selection.getCursor(); ##获取光标所在行或列
            //editor.gotoLine(lineNumber); ##跳转到行
            //editor.session.getLength(); ##获取总行数
            //editor.getSession().setTabSize(4); ##设置默认制表符的大小
            //editor.getSession().setUseSoftTabs(true); ##使用软标签.
            //document.getElementById('editor').style.fontSize='12px';  ##设置字体大小
            //editor.getSession().setUseWrapMode(true); ##设置代码折叠
            //editor.setHighlightActiveLine(false); ##设置高亮
            //editor.setShowPrintMargin(false); ##设置打印边距可见度

        </script>
    </div>
</body>
</html>